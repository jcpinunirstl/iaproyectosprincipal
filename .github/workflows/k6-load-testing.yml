name: K6 Load Testing - Login

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Tipo de prueba a ejecutar'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
          - all

jobs:
  setup-test-user:
    runs-on: ubuntu-latest
    outputs:
      test_username: ${{ steps.create_user.outputs.username }}
      test_password: ${{ steps.create_user.outputs.password }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore ia-proyecto-eventos/IaProyectoEventos.csproj

      - name: Build API
        run: dotnet build ia-proyecto-eventos/IaProyectoEventos.csproj --configuration Release --no-restore

      - name: Start API
        run: |
          cd ia-proyecto-eventos
          timeout 120 dotnet run --configuration Release &
          echo "API_PID=$!" >> $GITHUB_ENV
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for API to be ready
        run: |
          echo "Esperando a que la API est√© lista..."
          for i in {1..30}; do
            if curl -f http://localhost:7142/api/usuarios > /dev/null 2>&1; then
              echo "API est√° lista!"
              exit 0
            fi
            echo "Intento $i: esperando..."
            sleep 2
          done
          echo "API no respondi√≥ a tiempo"
          exit 1

      - name: Create test user
        id: create_user
        run: |
          TEST_USERNAME="testuser_${{ github.run_id }}"
          TEST_PASSWORD="TestPassword123!$(date +%s)"
          
          RESPONSE=$(curl -s -X POST http://localhost:7142/api/usuarios/register \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"$TEST_USERNAME\",
              \"password\": \"$TEST_PASSWORD\",
              \"email\": \"${TEST_USERNAME}@test.com\",
              \"nombre\": \"Test User\",
              \"telefono\": \"1234567890\",
              \"genero\": \"M\"
            }")
          
          echo "Register response: $RESPONSE"
          
          echo "username=$TEST_USERNAME" >> $GITHUB_OUTPUT
          echo "password=$TEST_PASSWORD" >> $GITHUB_OUTPUT

  smoke-test:
    needs: setup-test-user
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'smoke' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Start API
        run: |
          cd ia-proyecto-eventos
          dotnet build --configuration Release
          timeout 600 dotnet run --configuration Release &
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for API
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:7142/api/usuarios > /dev/null 2>&1; then
              echo "API listo"
              exit 0
            fi
            sleep 2
          done
          exit 1

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Smoke Tests
        run: |
          mkdir -p k6-reports
          k6 run \
            --vus 1 \
            --duration 10s \
            --summary-export=k6-reports/smoke-results.json \
            ia-proyecto-eventos/scripts/k6-smoke-test-login.js \
            -e BASE_URL=http://localhost:7142 \
            -e TEST_USERNAME="${{ needs.setup-test-user.outputs.test_username }}" \
            -e TEST_PASSWORD="${{ needs.setup-test-user.outputs.test_password }}"

      - name: Generate HTML Report
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('k6-reports/smoke-results.json', 'utf8'));
          
          const timestamp = new Date().toISOString().split('T')[0];
          const totalReqs = data.metrics.http_reqs?.values?.count || 0;
          const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
          const successReqs = totalReqs - failedReqs;
          const availability = totalReqs > 0 ? ((successReqs / totalReqs) * 100).toFixed(2) : 0;
          
          const html = \`
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset='utf-8'>
            <title>K6 Smoke Test Report</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
              .container { background: white; padding: 30px; border-radius: 8px; max-width: 800px; margin: 0 auto; }
              .header { color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 20px; }
              .status { padding: 15px; margin: 20px 0; border-radius: 5px; }
              .success { background: #d4edda; color: #155724; }
              .error { background: #f8d7da; color: #721c24; }
              table { width: 100%; margin-top: 20px; border-collapse: collapse; }
              th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
              th { background: #f8f9fa; font-weight: bold; }
            </style>
          </head>
          <body>
            <div class='container'>
              <div class='header'><h1>üìä K6 Smoke Test Report</h1></div>
              <div class='status \${availability >= 99 ? 'success' : 'error'}'>
                <strong>Disponibilidad:</strong> \${availability}%
              </div>
              <table>
                <tr><th>M√©trica</th><th>Valor</th></tr>
                <tr><td>Total de solicitudes</td><td>\${totalReqs}</td></tr>
                <tr><td>Solicitudes exitosas</td><td>\${successReqs}</td></tr>
                <tr><td>Solicitudes fallidas</td><td>\${failedReqs}</td></tr>
                <tr><td>Disponibilidad</td><td>\${availability}%</td></tr>
              </table>
              <p style='margin-top: 30px; color: #666; font-size: 12px;'>Generado: \${timestamp}</p>
            </div>
          </body>
          </html>
          \`;
          
          fs.writeFileSync('k6-reports/smoke-report.html', html);
          console.log('Reporte HTML generado: k6-reports/smoke-report.html');
          "

      - name: Validate Availability
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('k6-reports/smoke-results.json', 'utf8'));
          
          const totalReqs = data.metrics.http_reqs?.values?.count || 0;
          const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
          const successReqs = totalReqs - failedReqs;
          const availability = totalReqs > 0 ? (successReqs / totalReqs) * 100 : 0;
          
          console.log('üìä Validaci√≥n de disponibilidad:');
          console.log('  ‚Ä¢ Total de solicitudes:', totalReqs);
          console.log('  ‚Ä¢ Solicitudes exitosas:', successReqs);
          console.log('  ‚Ä¢ Disponibilidad:', availability.toFixed(2) + '%');
          
          if (availability >= 99) {
            console.log('‚úÖ PRUEBA EXITOSA: Disponibilidad >= 99%');
            process.exit(0);
          } else {
            console.log('‚ùå PRUEBA FALLIDA: Disponibilidad < 99%');
            process.exit(1);
          }
          "

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-smoke-test-reports
          path: k6-reports/
          retention-days: 30

  load-test:
    needs: setup-test-user
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'load' || github.event.inputs.test_type == 'all'
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Start API
        run: |
          cd ia-proyecto-eventos
          dotnet build --configuration Release
          timeout 600 dotnet run --configuration Release &
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for API
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:7142/api/usuarios > /dev/null 2>&1; then
              echo "API listo"
              exit 0
            fi
            sleep 2
          done
          exit 1

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Load Tests
        run: |
          mkdir -p k6-reports
          k6 run \
            --summary-export=k6-reports/load-results.json \
            ia-proyecto-eventos/scripts/k6-load-test-login.js \
            -e BASE_URL=http://localhost:7142 \
            -e TEST_USERNAME="${{ needs.setup-test-user.outputs.test_username }}" \
            -e TEST_PASSWORD="${{ needs.setup-test-user.outputs.test_password }}"

      - name: Generate HTML Report
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('k6-reports/load-results.json', 'utf8'));
          
          const totalReqs = data.metrics.http_reqs?.values?.count || 0;
          const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
          const successReqs = totalReqs - failedReqs;
          const availability = totalReqs > 0 ? ((successReqs / totalReqs) * 100).toFixed(2) : 0;
          
          const html = \`<!DOCTYPE html><html><head><meta charset='utf-8'><title>K6 Load Test Report</title><style>body{font-family:Arial,sans-serif;margin:40px;background:#f5f5f5}.container{background:white;padding:30px;border-radius:8px;max-width:800px;margin:0 auto}.header{color:#667eea;border-bottom:2px solid #667eea;padding-bottom:20px}.status{padding:15px;margin:20px 0;border-radius:5px}.success{background:#d4edda;color:#155724}.error{background:#f8d7da;color:#721c24}table{width:100%;margin-top:20px;border-collapse:collapse}th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd}th{background:#f8f9fa;font-weight:bold}</style></head><body><div class='container'><div class='header'><h1>üìä K6 Load Test Report</h1></div><div class='status \${availability >= 99 ? 'success' : 'error'}'><strong>Disponibilidad:</strong> \${availability}%</div><table><tr><th>M√©trica</th><th>Valor</th></tr><tr><td>Total de solicitudes</td><td>\${totalReqs}</td></tr><tr><td>Solicitudes exitosas</td><td>\${successReqs}</td></tr><tr><td>Solicitudes fallidas</td><td>\${failedReqs}</td></tr><tr><td>Disponibilidad</td><td>\${availability}%</td></tr></table></div></body></html>\`;
          fs.writeFileSync('k6-reports/load-report.html', html);
          console.log('Reporte HTML generado');
          "

      - name: Validate Availability
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('k6-reports/load-results.json', 'utf8'));
          
          const totalReqs = data.metrics.http_reqs?.values?.count || 0;
          const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
          const successReqs = totalReqs - failedReqs;
          const availability = totalReqs > 0 ? (successReqs / totalReqs) * 100 : 0;
          
          console.log('üìä Load Test - Validaci√≥n de disponibilidad:');
          console.log('  ‚Ä¢ Disponibilidad:', availability.toFixed(2) + '%');
          
          if (availability >= 99) {
            console.log('‚úÖ PRUEBA EXITOSA');
            process.exit(0);
          } else {
            console.log('‚ùå PRUEBA FALLIDA: Disponibilidad < 99%');
            process.exit(1);
          }
          "

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-load-test-reports
          path: k6-reports/
          retention-days: 30

  stress-test:
    needs: setup-test-user
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'stress' || github.event.inputs.test_type == 'all'
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Start API
        run: |
          cd ia-proyecto-eventos
          dotnet build --configuration Release
          timeout 600 dotnet run --configuration Release &
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for API
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:7142/api/usuarios > /dev/null 2>&1; then
              echo "API listo"
              exit 0
            fi
            sleep 2
          done
          exit 1

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Stress Tests
        run: |
          mkdir -p k6-reports
          k6 run \
            --summary-export=k6-reports/stress-results.json \
            ia-proyecto-eventos/scripts/k6-stress-test-login.js \
            -e BASE_URL=http://localhost:7142 \
            -e TEST_USERNAME="${{ needs.setup-test-user.outputs.test_username }}" \
            -e TEST_PASSWORD="${{ needs.setup-test-user.outputs.test_password }}"

      - name: Generate HTML Report
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('k6-reports/stress-results.json', 'utf8'));
          
          const totalReqs = data.metrics.http_reqs?.values?.count || 0;
          const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
          const successReqs = totalReqs - failedReqs;
          const availability = totalReqs > 0 ? ((successReqs / totalReqs) * 100).toFixed(2) : 0;
          
          const html = \`<!DOCTYPE html><html><head><meta charset='utf-8'><title>K6 Stress Test Report</title><style>body{font-family:Arial,sans-serif;margin:40px;background:#f5f5f5}.container{background:white;padding:30px;border-radius:8px;max-width:800px;margin:0 auto}.header{color:#667eea;border-bottom:2px solid #667eea;padding-bottom:20px}.status{padding:15px;margin:20px 0;border-radius:5px}.success{background:#d4edda;color:#155724}.error{background:#f8d7da;color:#721c24}table{width:100%;margin-top:20px;border-collapse:collapse}th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd}th{background:#f8f9fa;font-weight:bold}</style></head><body><div class='container'><div class='header'><h1>üìä K6 Stress Test Report</h1></div><div class='status \${availability >= 99 ? 'success' : 'error'}'><strong>Disponibilidad:</strong> \${availability}%</div><table><tr><th>M√©trica</th><th>Valor</th></tr><tr><td>Total de solicitudes</td><td>\${totalReqs}</td></tr><tr><td>Solicitudes exitosas</td><td>\${successReqs}</td></tr><tr><td>Solicitudes fallidas</td><td>\${failedReqs}</td></tr><tr><td>Disponibilidad</td><td>\${availability}%</td></tr></table></div></body></html>\`;
          fs.writeFileSync('k6-reports/stress-report.html', html);
          console.log('Reporte HTML generado');
          "

      - name: Validate Availability
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('k6-reports/stress-results.json', 'utf8'));
          
          const totalReqs = data.metrics.http_reqs?.values?.count || 0;
          const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
          const successReqs = totalReqs - failedReqs;
          const availability = totalReqs > 0 ? (successReqs / totalReqs) * 100 : 0;
          
          console.log('üìä Stress Test - Validaci√≥n de disponibilidad:');
          console.log('  ‚Ä¢ Disponibilidad:', availability.toFixed(2) + '%');
          
          if (availability >= 99) {
            console.log('‚úÖ PRUEBA EXITOSA');
            process.exit(0);
          } else {
            console.log('‚ö†Ô∏è PRUEBA CON ADVERTENCIA: Disponibilidad < 99% (esperado en stress test)');
            process.exit(0);
          }
          "

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-stress-test-reports
          path: k6-reports/
          retention-days: 30
