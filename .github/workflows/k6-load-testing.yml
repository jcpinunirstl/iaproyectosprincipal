name: K6 Load Testing - Login

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Tipo de prueba a ejecutar'
        required: false
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
          - all

env:
  TEST_USERNAME: 'ciuser'
  TEST_PASSWORD: 'CIPassword123!'

jobs:
  test-setup:
    name: Compile and Setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore ia-proyecto-eventos/IaProyectoEventos.csproj

      - name: Build API (Release)
        run: dotnet build ia-proyecto-eventos/IaProyectoEventos.csproj --configuration Release --no-restore

      - name: Cache .NET packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

  smoke-test:
    name: Smoke Test
    needs: test-setup
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      github.event.inputs.test_type == 'smoke' ||
      github.event.inputs.test_type == 'all'
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Start API (Background)
        run: |
          cd ia-proyecto-eventos
          nohup dotnet run --configuration Release > api.log 2>&1 &
          echo "API started in background"
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for API Ready
        run: |
          echo "Waiting for API to start..."
          timeout 60 bash -c 'until curl -s http://localhost:5142/api/usuarios > /dev/null; do sleep 1; done'
          echo "API is ready!"

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Smoke Tests
        run: |
          mkdir -p k6-reports
          k6 run \
            --vus 1 \
            --duration 10s \
            --summary-export=k6-reports/smoke-results.json \
            IaProyectoEventos.Tests/scripts/k6-smoke-test-login.js \
            -e BASE_URL=http://localhost:5142 \
            -e TEST_USERNAME=${{ env.TEST_USERNAME }} \
            -e TEST_PASSWORD=${{ env.TEST_PASSWORD }}
        continue-on-error: true

      - name: Generate HTML Report
        if: always()
        run: bash -c '
          if [ -f k6-reports/smoke-results.json ]; then
            node << "EOF"
            const fs = require("fs");
            const data = JSON.parse(fs.readFileSync("k6-reports/smoke-results.json", "utf8"));
            const totalReqs = data.metrics.http_reqs?.values?.count || 0;
            const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
            const successReqs = totalReqs - failedReqs;
            const availability = totalReqs > 0 ? ((successReqs / totalReqs) * 100).toFixed(2) : 0;
            const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>K6 Smoke Test Report</title><style>body{font-family:Arial,sans-serif;margin:40px;background:#f5f5f5}.container{background:white;padding:30px;border-radius:8px;max-width:800px;margin:0 auto}.header{color:#667eea;border-bottom:2px solid #667eea;padding-bottom:20px}.status{padding:15px;margin:20px 0;border-radius:5px}.success{background:#d4edda;color:#155724}.error{background:#f8d7da;color:#721c24}table{width:100%;margin-top:20px;border-collapse:collapse}th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd}th{background:#f8f9fa;font-weight:bold}</style></head><body><div class="container"><div class="header"><h1>üìä K6 Smoke Test Report</h1></div><div class="status ${availability >= 99 ? "success" : "error"}"><strong>Disponibilidad:</strong> ${availability}%</div><table><tr><th>M√©trica</th><th>Valor</th></tr><tr><td>Total de solicitudes</td><td>${totalReqs}</td></tr><tr><td>Solicitudes exitosas</td><td>${successReqs}</td></tr><tr><td>Solicitudes fallidas</td><td>${failedReqs}</td></tr><tr><td>Disponibilidad</td><td>${availability}%</td></tr></table></div></body></html>`;
            fs.writeFileSync("k6-reports/smoke-report.html", html);
            console.log("‚úÖ Reporte HTML generado");
            EOF
          else
            echo "‚ö†Ô∏è No results file found"
          fi
        '

      - name: Validate Results
        if: always()
        run: bash -c '
          if [ -f k6-reports/smoke-results.json ]; then
            node << "EOF"
            const fs = require("fs");
            const data = JSON.parse(fs.readFileSync("k6-reports/smoke-results.json", "utf8"));
            const totalReqs = data.metrics.http_reqs?.values?.count || 0;
            const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
            const successReqs = totalReqs - failedReqs;
            const availability = totalReqs > 0 ? (successReqs / totalReqs) * 100 : 0;
            console.log("üìä Smoke Test Results:");
            console.log(`   Total: ${totalReqs}, Exitosas: ${successReqs}, Fallidas: ${failedReqs}`);
            console.log(`   Disponibilidad: ${availability.toFixed(2)}%`);
            process.exit(availability >= 95 ? 0 : 1);
            EOF
          fi
        '

      - name: Upload Smoke Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-smoke-test-reports
          path: k6-reports/
          retention-days: 30

  load-test:
    name: Load Test
    needs: test-setup
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_type == 'load' ||
      github.event.inputs.test_type == 'all'
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Start API (Background)
        run: |
          cd ia-proyecto-eventos
          nohup dotnet run --configuration Release > api.log 2>&1 &
          echo "API started in background"
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for API Ready
        run: |
          echo "Waiting for API to start..."
          timeout 60 bash -c 'until curl -s http://localhost:5142/api/usuarios > /dev/null; do sleep 1; done'
          echo "API is ready!"

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Load Tests (‚âà4-5 minutes)
        run: |
          mkdir -p k6-reports
          k6 run \
            --summary-export=k6-reports/load-results.json \
            IaProyectoEventos.Tests/scripts/k6-load-test-login.js \
            -e BASE_URL=http://localhost:5142 \
            -e TEST_USERNAME=${{ env.TEST_USERNAME }} \
            -e TEST_PASSWORD=${{ env.TEST_PASSWORD }}
        continue-on-error: true
        timeout-minutes: 10

      - name: Generate HTML Report
        if: always()
        run: bash -c '
          if [ -f k6-reports/load-results.json ]; then
            node << "EOF"
            const fs = require("fs");
            const data = JSON.parse(fs.readFileSync("k6-reports/load-results.json", "utf8"));
            const totalReqs = data.metrics.http_reqs?.values?.count || 0;
            const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
            const successReqs = totalReqs - failedReqs;
            const availability = totalReqs > 0 ? ((successReqs / totalReqs) * 100).toFixed(2) : 0;
            const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>K6 Load Test Report</title><style>body{font-family:Arial,sans-serif;margin:40px;background:#f5f5f5}.container{background:white;padding:30px;border-radius:8px;max-width:800px;margin:0 auto}.header{color:#667eea;border-bottom:2px solid #667eea;padding-bottom:20px}.status{padding:15px;margin:20px 0;border-radius:5px}.success{background:#d4edda;color:#155724}.error{background:#f8d7da;color:#721c24}table{width:100%;margin-top:20px;border-collapse:collapse}th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd}th{background:#f8f9fa;font-weight:bold}</style></head><body><div class="container"><div class="header"><h1>üìä K6 Load Test Report</h1></div><div class="status ${availability >= 99 ? "success" : "error"}"><strong>Disponibilidad:</strong> ${availability}%</div><table><tr><th>M√©trica</th><th>Valor</th></tr><tr><td>Total de solicitudes</td><td>${totalReqs}</td></tr><tr><td>Solicitudes exitosas</td><td>${successReqs}</td></tr><tr><td>Solicitudes fallidas</td><td>${failedReqs}</td></tr><tr><td>Disponibilidad</td><td>${availability}%</td></tr></table></div></body></html>`;
            fs.writeFileSync("k6-reports/load-report.html", html);
            console.log("‚úÖ Reporte HTML generado");
            EOF
          fi
        '

      - name: Validate Results
        if: always()
        run: bash -c '
          if [ -f k6-reports/load-results.json ]; then
            node << "EOF"
            const fs = require("fs");
            const data = JSON.parse(fs.readFileSync("k6-reports/load-results.json", "utf8"));
            const totalReqs = data.metrics.http_reqs?.values?.count || 0;
            const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
            const successReqs = totalReqs - failedReqs;
            const availability = totalReqs > 0 ? (successReqs / totalReqs) * 100 : 0;
            console.log("üìä Load Test Results:");
            console.log(`   Total: ${totalReqs}, Exitosas: ${successReqs}, Fallidas: ${failedReqs}`);
            console.log(`   Disponibilidad: ${availability.toFixed(2)}%`);
            process.exit(availability >= 95 ? 0 : 1);
            EOF
          fi
        '

      - name: Upload Load Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-load-test-reports
          path: k6-reports/
          retention-days: 30

  stress-test:
    name: Stress Test
    needs: test-setup
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_type == 'stress' ||
      github.event.inputs.test_type == 'all'
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Start API (Background)
        run: |
          cd ia-proyecto-eventos
          nohup dotnet run --configuration Release > api.log 2>&1 &
          echo "API started in background"
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for API Ready
        run: |
          echo "Waiting for API to start..."
          timeout 60 bash -c 'until curl -s http://localhost:5142/api/usuarios > /dev/null; do sleep 1; done'
          echo "API is ready!"

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Stress Tests (‚âà5-6 minutes)
        run: |
          mkdir -p k6-reports
          k6 run \
            --summary-export=k6-reports/stress-results.json \
            IaProyectoEventos.Tests/scripts/k6-stress-test-login.js \
            -e BASE_URL=http://localhost:5142 \
            -e TEST_USERNAME=${{ env.TEST_USERNAME }} \
            -e TEST_PASSWORD=${{ env.TEST_PASSWORD }}
        continue-on-error: true
        timeout-minutes: 15

      - name: Generate HTML Report
        if: always()
        run: bash -c '
          if [ -f k6-reports/stress-results.json ]; then
            node << "EOF"
            const fs = require("fs");
            const data = JSON.parse(fs.readFileSync("k6-reports/stress-results.json", "utf8"));
            const totalReqs = data.metrics.http_reqs?.values?.count || 0;
            const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
            const successReqs = totalReqs - failedReqs;
            const availability = totalReqs > 0 ? ((successReqs / totalReqs) * 100).toFixed(2) : 0;
            const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>K6 Stress Test Report</title><style>body{font-family:Arial,sans-serif;margin:40px;background:#f5f5f5}.container{background:white;padding:30px;border-radius:8px;max-width:800px;margin:0 auto}.header{color:#667eea;border-bottom:2px solid #667eea;padding-bottom:20px}.status{padding:15px;margin:20px 0;border-radius:5px}.success{background:#d4edda;color:#155724}.error{background:#f8d7da;color:#721c24}table{width:100%;margin-top:20px;border-collapse:collapse}th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd}th{background:#f8f9fa;font-weight:bold}</style></head><body><div class="container"><div class="header"><h1>üìä K6 Stress Test Report</h1></div><div class="status ${availability >= 85 ? "success" : "error"}"><strong>Disponibilidad:</strong> ${availability}%</div><table><tr><th>M√©trica</th><th>Valor</th></tr><tr><td>Total de solicitudes</td><td>${totalReqs}</td></tr><tr><td>Solicitudes exitosas</td><td>${successReqs}</td></tr><tr><td>Solicitudes fallidas</td><td>${failedReqs}</td></tr><tr><td>Disponibilidad</td><td>${availability}%</td></tr></table></div></body></html>`;
            fs.writeFileSync("k6-reports/stress-report.html", html);
            console.log("‚úÖ Reporte HTML generado");
            EOF
          fi
        '

      - name: Validate Results
        if: always()
        run: bash -c '
          if [ -f k6-reports/stress-results.json ]; then
            node << "EOF"
            const fs = require("fs");
            const data = JSON.parse(fs.readFileSync("k6-reports/stress-results.json", "utf8"));
            const totalReqs = data.metrics.http_reqs?.values?.count || 0;
            const failedReqs = data.metrics.http_reqs?.values?.fails || 0;
            const successReqs = totalReqs - failedReqs;
            const availability = totalReqs > 0 ? (successReqs / totalReqs) * 100 : 0;
            console.log("üìä Stress Test Results:");
            console.log(`   Total: ${totalReqs}, Exitosas: ${successReqs}, Fallidas: ${failedReqs}`);
            console.log(`   Disponibilidad: ${availability.toFixed(2)}%`);
            console.log("   Note: Stress test tolera disponibilidad < 99%");
            process.exit(0);
            EOF
          fi
        '

      - name: Upload Stress Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-stress-test-reports
          path: k6-reports/
          retention-days: 30
